{
  "_errors_and_fixes": [
    {
      "bug": 1,
      "location": "Append_to_string_variable → inputs.value (outer loop)",
      "problem": "Value is a plain string — the @ prefix is missing. Power Automate does not evaluate expressions without @. It appended the literal text \"concat('<h3>'...)\" into the variable instead of the result.",
      "original":  "concat('<h3>', items('Apply_to_each')?['title'], '</h3>')",
      "fixed":    "@concat('<h3>', items('Apply_to_each')?['title'], '</h3>')"
    },
    {
      "bug": 2,
      "location": "Apply_to_each_1 → foreach",
      "problem": "Iterating over @items('Apply_to_each') targets the checklist object itself — a single object, not an array. Power Automate either errors or iterates over the object's properties. The inner loop needs to target the 'items' array inside each checklist object.",
      "original":  "@items('Apply_to_each')",
      "fixed":    "@items('Apply_to_each')?['items']"
    },
    {
      "bug": 3,
      "location": "Append_to_string_variable_1 → inputs.value (inner loop)",
      "problem": "Two problems: (a) same missing @ prefix as Bug 1. (b) references items('Apply_to_each_2') which does not exist — the inner loop action is named Apply_to_each_1, so the current item inside it is items('Apply_to_each_1'), not items('Apply_to_each_2').",
      "original":  "concat('<p>', if(equals(items('Apply_to_each_2')?['status'], 'complete'), '&#10003;', '&#9744;'), ' ', items('Apply_to_each_2')?['title'], '</p>')",
      "fixed":    "@concat('<p><input type=\"checkbox\"', if(equals(items('Apply_to_each_1')?['status'], 'complete'), ' checked', ''), ' disabled/> ', items('Apply_to_each_1')?['title'], '</p>')"
    },
    {
      "bug": 4,
      "location": "Append_to_string_variable_1 → inputs.value — status field value mismatch",
      "problem": "The Placker API status value for checklist items is not confirmed to be 'complete'. Testing showed all items rendering as unchecked regardless of their actual state. The condition equals(item()?['status'], 'complete') never evaluates to true. Step 1: use the DIAGNOSTIC expression below to reveal the actual field name and value. Step 2: once confirmed, switch to the PRODUCTION expression.",
      "diagnostic_expression": "@concat('<p>[status=', string(items('Apply_to_each_1')?['status']), '] ', items('Apply_to_each_1')?['title'], '</p>')",
      "diagnostic_note": "Paste this temporarily into Append_to_string_variable_1. Run the flow, open Run History, read the HTML output. The [status=VALUE] prefix on each item shows the exact value the API returns — e.g. [status=complete], [status=true], [status=done]. Update the production expression accordingly.",
      "production_expression": "@concat('<p>', if(or(equals(items('Apply_to_each_1')?['status'], 'complete'), equals(items('Apply_to_each_1')?['checked'], true), equals(items('Apply_to_each_1')?['state'], 'complete')), '&#10003; ', ''), items('Apply_to_each_1')?['title'], '</p>')",
      "production_note": "Checks three common status patterns: status='complete', checked=true, state='complete'. If the diagnostic shows a different value, add equals(items('Apply_to_each_1')?['FIELDNAME'], 'VALUE') to the or() list."
    },
    {
      "bug": 5,
      "location": "Compose - Build HTML Content → inputs (Action 7)",
      "problem": "join(body('Select_-_Format_Checklists'),'') is still in the Compose expression. Now that the Apply to each loop writes to varChecklistsHTML, the Select action is redundant. Its join() output is producing the '' characters visible before <h3> in the HTML. Replace join(body('Select_-_Format_Checklists'),'') with variables('varChecklistsHTML') in the Compose inputs.",
      "original":  "join(body('Select_-_Format_Checklists'),'')",
      "fixed":    "variables('varChecklistsHTML')"
    }
  ],

  "_rule": "In Power Automate, items('ActionName') always uses the name of the foreach action that contains the step you are writing. Outer loop = items('Apply_to_each'). Inner loop = items('Apply_to_each_1'). If you rename either loop, every items() reference inside it must match the new name.",

  "type": "Foreach",
  "foreach": "@body('Get_Checklist')",
  "actions": {
    "Append_to_string_variable": {
      "type": "AppendToStringVariable",
      "inputs": {
        "name": "varChecklistsHTML",
        "value": "@concat('<h3 style=\"color:#225FAD;margin:10px 0 4px 0;\">', items('Apply_to_each')?['title'], '</h3>')"
      }
    },
    "Apply_to_each_1": {
      "type": "Foreach",
      "foreach": "@items('Apply_to_each')?['items']",
      "actions": {
        "Append_to_string_variable_1": {
          "type": "AppendToStringVariable",
          "inputs": {
            "name": "varChecklistsHTML",
            "_note": "Force all items as checked (&#9745;) — no status condition needed. The Trello automation moves the card to Done only when every checklist item is complete, so all items are guaranteed complete by the time this flow fires.",
            "value": "@concat('<p style=\"margin:2px 0;\">&#9745; ', items('Apply_to_each_1')?['title'], '</p>')"
          }
        }
      },
      "runAfter": {
        "Append_to_string_variable": [
          "Succeeded"
        ]
      }
    }
  },
  "runAfter": {
    "Format_Checklists": [
      "Succeeded"
    ]
  }
}
